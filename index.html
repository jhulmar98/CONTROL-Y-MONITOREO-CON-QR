<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Integral de Monitoreo y Alerta</title>

  <!-- üé® Estilos principales -->
  <link rel="stylesheet" href="styles.css" />

  <!-- üó∫Ô∏è Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
  <!-- ============================================================
       üß≠ BARRA SUPERIOR (NAVBAR)
       ============================================================ -->
  <nav class="navbar">
    <!-- Bot√≥n del men√∫ m√≥vil -->
    <button class="menu-toggle" id="menuToggle">‚ò∞</button>

    <!-- Botones principales (solo escritorio) -->
    <div class="nav-buttons desktop-only">
      <button class="btn" id="btnLocales">LOCALES</button>
      <button class="btn active" id="btnPersonal">PERSONAL</button>
    </div>

    <!-- T√≠tulo -->
    <h1>SISTEMA INTEGRAL DE MONITOREO</h1>

    <!-- Cerrar sesi√≥n (solo escritorio) -->
    <div class="user-actions desktop-only">
      <button class="btn logout-btn" id="btnLogout">Cerrar sesi√≥n</button>
    </div>
  </nav>

  <!-- Overlay (para cerrar men√∫ m√≥vil) -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- ============================================================
       üß± CONTENEDOR PRINCIPAL
       ============================================================ -->
  <div class="container">
    <!-- =============================== -->
    <!-- üìÇ SIDEBAR / PANEL LATERAL -->
    <!-- =============================== -->
    <aside class="sidebar" id="sidebar">

      <!-- üîπ Opciones principales solo para m√≥viles -->
      <div class="mobile-menu mobile-only">
        <button class="btn" id="btnPersonalMobile">PERSONAL</button>
        <button class="btn" id="btnLocalesMobile">LOCALES</button>
        <button class="logout-btn" id="btnLogoutMobile">Cerrar sesi√≥n</button>
      </div>

      <!-- PANEL PERSONAL -->
      <div class="panel" id="panel-personal">
        <h2>PERSONAL <span class="count">0</span></h2>
        <input type="date" id="fecha" placeholder="dd/mm/aaaa" />

        <div class="turnos">
          <span>Turno</span>
          <div class="turno-buttons">
            <button class="mini-btn active" data-turno="TI">TI</button>
            <button class="mini-btn" data-turno="T2">T2</button>
            <button class="mini-btn" data-turno="T3">T3</button>
            <button class="mini-btn" data-turno="TODO">Todo</button>
          </div>
        </div>

        <input type="text" id="buscador" placeholder="Nombre o C√≥digo" />
        <label class="check">
          <input type="checkbox" id="soloComentario" /> Con comentario
        </label>
        <button class="btn full" id="btnHoy">Hoy</button>
      </div>

      <!-- PANEL REPORTES -->
      <div class="panel" id="panel-reportes">
        <h2>REPORTES</h2>
        <button class="report-btn" id="btnReporteSerenos">üìä Reporte Serenos</button>
        <button class="report-btn" id="btnReporteLocales">üìä Reporte Locales</button>
        <button class="report-btn" id="btnReporteCalificaciones">üìë Ver Calificaciones</button>
        <button class="report-btn" id="btnNotificaciones">üí¨ Ver Notificaciones</button>
      </div>

      <!-- PANEL LOCALES -->
      <div class="panel" id="panel-locales" style="display:none;">
        <h2>LOCALES <span class="count-locales">0</span></h2>
        <label for="filtroEstadoLocales">Estado</label>
        <select id="filtroEstadoLocales">
          <option value="TODO">Todos</option>
          <option value="PATRULLADOS">Patrullados</option>
          <option value="NOPATRULLADOS">No patrullados</option>
        </select>
        <input type="text" id="buscarLocal" placeholder="Nombre del local..." />
        <div id="listaLocales" class="lista-locales"></div>
      </div>
    </aside>

    <!-- =============================== -->
    <!-- üó∫Ô∏è √ÅREA PRINCIPAL / MAPA -->
    <!-- =============================== -->
    <main class="main-content">
      <div class="sector-legend" id="legend-sectores">
        <div class="card">
          <div class="title">SERENOS POR SECTOR</div>
          <div class="chips">
            <div class="chip"><span class="dot" style="background:#3b82f6"></span>S1 <span id="s1" class="val">0</span></div>
            <div class="chip"><span class="dot" style="background:#22c55e"></span>S2 <span id="s2" class="val">0</span></div>
            <div class="chip"><span class="dot" style="background:#ef4444"></span>S3 <span id="s3" class="val">0</span></div>
            <div class="chip"><span class="dot" style="background:#a855f7"></span>S4 <span id="s4" class="val">0</span></div>
            <div class="chip"><span class="dot" style="background:#f59e0b"></span>S5 <span id="s5" class="val">0</span></div>
          </div>
        </div>
      </div>

      <!-- Mapa -->
      <div id="map"></div>
    </main>
  </div>

  <!-- ============================================================
       üí¨ PANEL DE NOTIFICACIONES FLOTANTE
       ============================================================ -->
  <div id="panel-notificaciones" class="noti-float" style="display:none;">
    <div class="noti-header">
      <h2>NOTIFICACIONES</h2>
      <button id="btnCerrarNoti" class="close-btn">‚ùå</button>
    </div>
    <div id="notiFeed" class="noti-feed"></div>
    <div class="grp" style="display:none;"></div>
  </div>

  <!-- ============================================================
       ‚öôÔ∏è SCRIPTS
       ============================================================ -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const user = JSON.parse(localStorage.getItem("msiUser"));
    if (!user) window.location.href = "login.html";

    document.addEventListener("DOMContentLoaded", () => {
      const sidebar = document.getElementById("sidebar");
      const menuToggle = document.getElementById("menuToggle");
      const overlay = document.getElementById("menuOverlay");

      // Cerrar sesi√≥n (todos los botones)
      const logoutBtns = [document.getElementById("btnLogout"), document.getElementById("btnLogoutMobile")];
      logoutBtns.forEach(btn => {
        if (btn) btn.addEventListener("click", () => {
          localStorage.removeItem("msiUser");
          window.location.href = "login.html";
        });
      });

      // Men√∫ lateral
      menuToggle.addEventListener("click", () => {
        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
      });

      overlay.addEventListener("click", () => {
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
      });

      // Vincular botones m√≥viles con sus equivalentes
      const btnLocalesMobile = document.getElementById("btnLocalesMobile");
      const btnPersonalMobile = document.getElementById("btnPersonalMobile");

      btnLocalesMobile.addEventListener("click", () => {
        document.getElementById("btnLocales").click();
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
      });
      btnPersonalMobile.addEventListener("click", () => {
        document.getElementById("btnPersonal").click();
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
      });
    });
  </script>

  <!-- M√≥dulos principales -->
  <script type="module" src="js/mapa.js"></script>
  <script type="module" src="js/turno.js"></script>
  <script type="module" src="js/personal.js"></script>
  <script type="module" src="js/localesPanel.js"></script>
  <script type="module" src="js/reportesSerenos.js"></script>
  <script type="module" src="js/reportesLocales.js"></script>
  <script type="module" src="js/notificaciones.js"></script>
  <script type="module" src="js/reportesCalificaciones.js"></script>

  <!-- Inicializaci√≥n -->
  <script type="module">
    import { initNotificacionesUI } from "./js/notificaciones.js";
    import { getConteoPersonal, getSerenosPorSector } from "./js/personal.js";
    import { getLocalesRojos } from "./js/localesPanel.js";
    import { abrirReporteSerenos } from "./js/reportesSerenos.js";
    import { abrirReporteLocales } from "./js/reportesLocales.js";
    import { abrirReporteCalificaciones } from "./js/reportesCalificaciones.js";

    const btnLocales = document.getElementById("btnLocales");
    const btnPersonal = document.getElementById("btnPersonal");
    const btnNotificaciones = document.getElementById("btnNotificaciones");
    const btnCerrarNoti = document.getElementById("btnCerrarNoti");

    const panelLocales = document.getElementById("panel-locales");
    const panelPersonal = document.getElementById("panel-personal");
    const panelReportes = document.getElementById("panel-reportes");
    const legendSectores = document.getElementById("legend-sectores");
    const fechaInput = document.getElementById("fecha");

    // Funciones auxiliares
    function getTurnoActivo() {
      return document.querySelector(".turno-buttons .mini-btn.active")?.dataset.turno || "TI";
    }
    function getFechaActual() {
      return fechaInput?.value || new Date().toISOString().slice(0, 10);
    }

    // üîπ Muestra solo el panel deseado y oculta los dem√°s
    function showPanel(panel) {
      panelLocales.style.display = "none";
      panelPersonal.style.display = "none";
      panelReportes.style.display = "none";
      legendSectores.style.display = "none";
      if (panel) panel.style.display = "block";
    }

    // ============================================================
    // üß≠ BOT√ìN: LOCALES
    // ============================================================
    btnLocales.addEventListener("click", () => {
      btnLocales.classList.add("active");
      btnPersonal.classList.remove("active");

      // üî∏ Mostrar solo LOCALES
      showPanel(panelLocales);

      // üî∏ Ocultar leyenda y reportes
      legendSectores.style.display = "none";
      panelReportes.style.display = "none";

      // üî∏ Evento para que el mapa cargue solo locales
      const evento = new CustomEvent("showLocales", {
        detail: { fecha: getFechaActual(), turno: getTurnoActivo() },
      });
      window.dispatchEvent(evento);
    });

    // ============================================================
    // üß≠ BOT√ìN: PERSONAL
    // ============================================================
    btnPersonal.addEventListener("click", () => {
      btnPersonal.classList.add("active");
      btnLocales.classList.remove("active");

      // üî∏ Mostrar personal, reportes y leyenda
      showPanel(panelPersonal);
      panelReportes.style.display = "block";
      legendSectores.style.display = "block";

      // üî∏ Evento para que el mapa vuelva a mostrar los serenos
      const evento = new CustomEvent("showPersonal", {
        detail: { fecha: getFechaActual(), turno: getTurnoActivo() },
      });
      window.dispatchEvent(evento);
    });

    // ============================================================
    // üìä REPORTES
    // ============================================================
    document.getElementById("btnReporteSerenos").addEventListener("click", abrirReporteSerenos);
    document.getElementById("btnReporteLocales").addEventListener("click", abrirReporteLocales);
    document.getElementById("btnReporteCalificaciones").addEventListener("click", abrirReporteCalificaciones);

    // ============================================================
    // üí¨ NOTIFICACIONES
    // ============================================================
    btnNotificaciones.addEventListener("click", () => {
      document.getElementById("panel-notificaciones").style.display = "flex";
    });
    btnCerrarNoti.addEventListener("click", () => {
      document.getElementById("panel-notificaciones").style.display = "none";
    });

    // ============================================================
    // üöÄ INICIALIZACI√ìN
    // ============================================================
    initNotificacionesUI(getConteoPersonal, getLocalesRojos, getSerenosPorSector);
  </script>

</body>
</html>
